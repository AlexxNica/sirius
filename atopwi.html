<html>
<head>
<title>Web Inspector Web App Over crx2app</title>


<script src="chrome-extension://fkhgelnmojgnpahkeemhnbjndeeocehc/MetaObject/requirejs/require.js"></script>
<script src="chrome-extension://fkhgelnmojgnpahkeemhnbjndeeocehc/RESTChannel/RESTChannel.js"></script>

<script>
/*globals window console require*/

var SiriusBase = 'chrome-extension://fkhgelnmojgnpahkeemhnbjndeeocehc';
window.crx2appBase = SiriusBase+'/crx2app/extension';

function extractParamsFromURL() {
  var search = window.location.search;
  if (search) {
    var parameterString = search.substr(1);
    if (parameterString) {
      var params = {};
      parameterString.split('&').forEach(function(param) {
        var nv = param.split('=');
        if (nv.length === 2 && nv[1]) {
          params[nv[0]] = nv[1];
        }
      });
      if (Object.keys(params).length) {
        return params;
      }
    }
  } // else undefined
}

function reloadWithURL(debuggeeURLElt) {
  var debuggeeURL = debuggeeURLElt.value;
  var base = window.location.href;
  base = base.split('?')[0];
  var relo = 'debuggee='+encodeURIComponent(debuggeeURL)+'&';
  window.open(base+'?'+relo);
}


function getDebuggeeSpec() {
  var debuggeeSpec = extractParamsFromURL();
  if (debuggeeSpec) {
    return debuggeeSpec;
  } else {
    // TODO just for testing
    var defaultDebuggeeURL = 'http://johnjbarton.github.com/webdev-examples/simple/scriptTagJSProject/index.html';
    //if (window.confirm('Use '+defaultDebuggeeURL)) {
      return {url: defaultDebuggeeURL};
    //}
  }
}

function URLOptions() {
  this.params = extractParamsFromURL() || {};
}

URLOptions.prototype = {
  useWebSocket: function() {
    return this.params.hasOwnProperty('ws');
  },
  useCrx2app: function() {
    return (this.params.hasOwnProperty('url') || this.params.hasOwnProperty('tabId'));
  },
  devToolsURL: function() {
    var devtoolsURL = window.SiriusBase + '/atopwi/inspector/front-end/devtools.html';
    if (this.useWebSocket()) {
      devtoolsURL += '?ws=' + this.params.ws;
    } // else params by postMessage...
    return devtoolsURL;
  },
  getDebuggeeSpec: function() {
    if (this.useWebSocket() || this.useCrx2app()) {
      return {
        url: this.params.url, 
        devtoolsURL: this.devToolsURL(),
        ws: this.params.ws
      };
    } // else none.
  }
};

function onLoad() {

  window.removeEventListener('load', onLoad, false);

  require({
      paths: {
        'crx2app': window.crx2appBase,
        'q': SiriusBase+'/MetaObject/q'
      }
    }); 
    
console.log('window.crx2appBase ', window.crx2appBase);

   require.onError = function(err) {
     console.error(err+'', {stack: err.stack.split('\n')});
   };
  
  require(['DevtoolsConnection'], function open(DevtoolsConnection) {
    var options = new URLOptions();
    var debuggeeSpec = options.getDebuggeeSpec();
    if (debuggeeSpec) {
      // connect to the chromeIframe
      DevtoolsConnection.openInspector(debuggeeSpec);
    } else {
      var prompt = document.querySelector('.debuggeeSpec');
      prompt.classList.remove('hide');
    }
  });
  
}

window.addEventListener('load', onLoad, false);

</script>
<style>
html, body, iframe {
  height: 100%;
  width: 100%;
  margin: 0px;  /* kill off any margin so we control */
  border: none;
}
body {
  font-family:Verdana,Geneva,sans-serif;
}
.hide {
  display: none;
}
#debuggee {
  margin: 20px;
}
.debuggeeSpec {
  margin: 20px;
}
</style>
</head>
<body>
<div class='hide' id='error'></div>
<div class='hide debuggeeSpec'>
<h1> Chrome Devtools as Web App </h1>
<h2>Using Chrome extension crx2App</h2>
<form >
URL to debug: <input id='debuggeeSpecURLElt' type='url' size='128'/>
  <button id="doDebug">Debug</button>
</form>
<h2>OR: Using Web Sockets</h2>
<div class="WebSocketSelector">
<iframe src="http://localhost:9222"></iframe>
</div>
</div>
<div class='hide' id="WebInspector"></div>
</body>
</html>

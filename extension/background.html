<!DOCTYPE html>
<!--
// Google BSD license http://code.google.com/google_bsd_license.html
// Copyright 2011 Google Inc. johnjbarton@google.com
-->
<html>
  <head>
  </head>
  <body>
    <script>
/*globals chrome console window */

      var debug = true;

//--------------------------------------------------------------------------
// Build list of Orion edit headers as the headers arrive

      var editableByTabId = {};
      var editSubString = "/edit/edit.html#";

      function checkForEditHeader(details) {

        var url = details.url;
        var tabId = details.tabId;
        
        if(debug) {
          console.log("checkForEditHeader "+url+" in "+tabId);
        }
        
        var editParameters = {};
        var headers = details.responseHeaders;
        headers.forEach(function findOrion(header) {
          if (header.name === "X-Edit-Server") {
            editParameters.server = header.value;
          } else if (header.name === "X-Edit-Token") {
            editParameters.token = header.value;
          }
        });
        
        if (editParameters.server && editParameters.token) {
          var editURL = editParameters.server + editParameters.token;
          if (!editableByTabId[tabId]) {
            editableByTabId[tabId] = [];
          }
          editableByTabId[tabId].push({url: url, editURL: editURL});
        }
      }
      
      chrome.webRequest.onCompleted.addListener(
         checkForEditHeader, 
         // main_frame for page action; script and stylesheet for devtools
         {urls: ["*://*/*"], types: ['main_frame', 'script', 'stylesheet']}, 
         ['responseHeaders']
       );
       
//-------------------------------------------------------------------------------
// Page Actions


      function openAsFilePageAction(url, tabId) {
        var ndx = url.indexOf(editSubString);
        if (ndx > 0) {
          chrome.pageAction.show(tabId);
          chrome.pageAction.setTitle({tabId: tabId, title: "Open As File"});
          return true;
        }
      }

      function openInOrionEditor(url, tabId) {   
        var editableTabIds = Object.keys(editableByTabId);
        editableTabIds.forEach(function(tabIdName) {
          var tabId = parseInt(tabIdName, 10);
           if(tabId) {
             chrome.pageAction.show(tabId);
             chrome.pageAction.setTitle({tabId: tabId, title: "Open In Orion Editor"});
             return true;
           }
        });
      }

      function checkForPageAction(url, tabId) {
        return openAsFilePageAction(url, tabId) || openInOrionEditor(url, tabId);
      }
   
      function reportListeners(where, like) {
        console.log(where+" has:"+chrome.webNavigation.onBeforeNavigate.hasListener(like)+" total: "+
         chrome.webNavigation.onBeforeNavigate.listeners_.length);
      }


//--------------------------------------------------------------------------
// Add Page Action onUpdated tab

      function onTabUpdated(tabId, changeInfo, tab) {
        checkForPageAction(tab.url, tab.id);
      }

      chrome.tabs.onUpdated.addListener(onTabUpdated);

      function onTabRemoved(tabId, removeInfo) {
        delete editableByTabId[tabId];
      }
       
      chrome.tabs.onRemoved.addListener(onTabRemoved);

//-----------------------------------------------------------------------------
// Open editor or file on page action click

      function pageAction(tab) {
        var editables = editableByTabId[tab.id];
        if (editables) {
          editables.forEach(function(editable) {
            if (editable.url === tab.url) {
              chrome.tabs.create({url: editable.editURL});
            }
          });
        } else {
          var ndx = tab.url.indexOf(editSubString);
          if (ndx > 0) {
            var fileURL = tab.url.substr(0, ndx);
            fileURL += tab.url.substr(ndx + editSubString.length);
            chrome.tabs.create({url: fileURL}, function(tab) {
              console.log("opened "+fileURL+" in ", tab);
            });
          }
        }
      }
      chrome.pageAction.onClicked.addListener(pageAction);

//------------------------------------------------------------------------------
// SuperLogin: reload all Orion pages after logging in.

  var debugRequests = true;

  function superLogin(request, sender, sendResponse) {
        sendResponse({farewell: "goodbye"});
        var host = sender.tab.url.split('/').slice(0,3).join('/');
        var tabs = [];
        chrome.windows.getAll({populate: true}, function(wins) {
          wins.forEach(function(win) {
            win.tabs.forEach(function(tab) {
              if (tab.url.indexOf(host) === 0 && tab.url !== sender.tab.url) {
                tabs.push(tab);
              }
            });
          });
          var msg = "Reload "+tabs.length+" Orion pages?";
          if (window.confirm(msg)) {
            if (debugRequests) {
              console.log("need to reload ", tabs);
            }
            tabs.forEach(function(tab) {
              chrome.tabs.reload(tab.id, {}, function() {
                if (chrome.extension.lastError) {
                  console.error("Reload failed for "+tab.url+" "+chrome.extension.lastError);
                } else {
                  if (debugRequests) {
                    console.log("Reloaded "+tab.url);
                  }
                }
              });
            });
          }
        });
  }


//------------------------------------------------------------------------------
// SuperLogin: reload all Orion pages after logging in.

  function saveResource(request, sender, sendResponse) {
    if (debug) {
      console.log("background.saveResource", request);
    }
    var editURL;
    var editableTabIds = Object.keys(editableByTabId);
    editableTabIds.forEach(function(tabId) {
      var editables = editableByTabId[tabId];
      editables.forEach(function(editable) {
        if (editable.url === request.url) {
          editURL = editable.editURL;
        }
      });
    });

    if (editURL) {
      console.log("background.saveResource ready to PUT to "+editURL);
    } else {
      console.log("background.saveResource no editURL matches "+request.url);
    }
  }

  chrome.extension.onRequest.addListener(
    function dispatch(request, sender, sendResponse) {
      if (debugRequests) {
        console.log(sender.tab ?
                  "from a content script:" + sender.tab.url :
                  "from the extension");
      }
      if (request.orion === "loginUnloading") {
        // built into Orion now superLogin(request, sender, sendResponse);
      } else if (request.message === "saveResource") {
        saveResource(request, sender, sendResponse);
      } else {
        sendResponse({}); // snub them.
      }
    }
  );
  

    </script>
  </body>
</html>
